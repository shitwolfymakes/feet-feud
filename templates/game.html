{% extends "base.html" %}

{% block content %}
<!-- Score Display -->
<div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; margin-bottom: 30px;">
    <div class="card" style="text-align: center; background: linear-gradient(45deg, #ff6b6b, #ee5a24);">
        <h3>{{ game.team1_name }}</h3>
        <div style="font-size: 2rem; font-weight: bold;">{{ game.team1_score }}</div>
    </div>
    
    <div class="card" style="text-align: center; min-width: 150px;">
        <h4>Round Points</h4>
        <div style="font-size: 1.5rem; color: #ffd700;">{{ game.round_points }}</div>
        <div style="margin-top: 10px;">
            <span style="color: #ff7675;">Strikes: </span>
            <span id="strikes-display">
                {% for i in range(game.strikes) %}❌{% endfor %}
                {% for i in range(3 - game.strikes) %}⭕{% endfor %}
            </span>
        </div>
    </div>
    
    <div class="card" style="text-align: center; background: linear-gradient(45deg, #4834d4, #686de0);">
        <h3>{{ game.team2_name }}</h3>
        <div style="font-size: 2rem; font-weight: bold;">{{ game.team2_score }}</div>
    </div>
</div>

<!-- Current Question -->
<div class="card" style="text-align: center;">
    <h2 style="color: #ffd700; margin-bottom: 20px;">{{ game.question }}</h2>
    <div style="font-size: 1.1rem; color: #74b9ff;">
        Current Team: <strong id="current-team">
            {% if game.current_team == 1 %}{{ game.team1_name }}{% else %}{{ game.team2_name }}{% endif %}
        </strong>
    </div>
</div>

<!-- Answer Board -->
<div class="card">
    <h3 style="text-align: center; margin-bottom: 20px; color: #74b9ff;">Survey Says...</h3>
    <div id="answer-board" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
        {% for answer in answers %}
        <div class="answer-slot" data-answer-id="{{ answer.id }}" data-points="{{ answer.points }}"
             onclick="revealAnswer(this)"
             style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; 
                    display: flex; justify-content: space-between; align-items: center;
                    border: 2px solid rgba(255,255,255,0.3); transition: all 0.3s ease;
                    cursor: pointer; min-height: 60px;">
            <span class="answer-text" style="font-weight: bold; display: none;">{{ answer.answer }}</span>
            <span class="answer-points" style="color: #ffd700; font-weight: bold; display: none;">{{ answer.points }}</span>
            <span class="answer-placeholder" style="color: #ddd; font-size: 1.2rem; width: 100%; text-align: center;">
                Click to Reveal Answer {{ loop.index }}
            </span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Game Controls -->
<div class="card" style="text-align: center;">
    <h3 style="color: #74b9ff; margin-bottom: 20px;">Host Controls</h3>
    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <button onclick="addStrike()" class="btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
            ❌ Add Strike
        </button>
        <button onclick="switchTeam()" class="btn btn-secondary">
            🔄 Switch Team
        </button>
        <button onclick="awardSteal()" class="btn" style="background: linear-gradient(45deg, #f39c12, #e67e22);" id="steal-btn" disabled>
            🎯 Award Steal
        </button>
    </div>
</div>

<!-- Steal Section (Hidden by default) -->
<div class="card" id="steal-section" style="display: none; text-align: center; background: rgba(241, 196, 15, 0.2);">
    <h3 style="color: #f1c40f; margin-bottom: 15px;">🚨 STEAL OPPORTUNITY! 🚨</h3>
    <p style="margin-bottom: 20px;">Click "Award Steal" if the other team gives a correct answer, or add a strike if they fail!</p>
</div>

<!-- Round Controls -->
<div class="card" style="text-align: center;">
    <button onclick="nextRound()" class="btn btn-secondary" style="margin-right: 10px;">
        🎲 Next Round
    </button>
    <button onclick="resetRound()" class="btn" style="background: linear-gradient(45deg, #95a5a6, #7f8c8d); margin-right: 10px;">
        🔄 Reset Round
    </button>
    <a href="/" class="btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
        🏁 End Game
    </a>
</div>

<!-- Messages -->
<div id="message-area"></div>
{% endblock %}

{% block scripts %}
let gameData = null;
let revealedAnswers = new Set();
let isStealMode = false;

// Load game data from server
async function loadGameData() {
    try {
        const response = await fetch('/game_data_json');
        gameData = await response.json();
        console.log('Game data loaded:', gameData);
    } catch (error) {
        console.error('Error loading game data:', error);
        showMessage('Error loading game data. Please refresh the page.', 'danger');
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadGameData();
    console.log('Game script loaded successfully');
});

function revealAnswer(answerElement) {
    if (!gameData) {
        console.error('Game data not loaded yet');
        return;
    }
    
    const answerId = answerElement.getAttribute('data-answer-id');
    const points = parseInt(answerElement.getAttribute('data-points'));
    
    // Don't reveal if already revealed
    if (revealedAnswers.has(answerId)) {
        return;
    }
    
    // Reveal the answer
    answerElement.querySelector('.answer-text').style.display = 'block';
    answerElement.querySelector('.answer-points').style.display = 'block';
    answerElement.querySelector('.answer-placeholder').style.display = 'none';
    answerElement.style.background = 'linear-gradient(45deg, #2ecc71, #27ae60)';
    answerElement.style.border = '2px solid #ffd700';
    answerElement.style.cursor = 'default';
    
    revealedAnswers.add(answerId);
    
    // Add points to current team
    if (isStealMode) {
        // Award all round points to stealing team
        awardPointsToStealingTeam();
        isStealMode = false;
        document.getElementById('steal-section').style.display = 'none';
        document.getElementById('steal-btn').disabled = true;
        showMessage('🎉 Successful steal! Points awarded to stealing team!', 'success');
    } else {
        // Add points to round total
        updateRoundPoints(gameData.game.round_points + points);
        showMessage(`✅ Correct! +${points} points added to round total!`, 'success');
    }
}

function addStrike() {
    if (!gameData) {
        console.error('Game data not loaded yet');
        return;
    }
    
    console.log('addStrike called'); // Debug log
    gameData.game.strikes++;
    updateStrikes(gameData.game.strikes);
    
    if (gameData.game.strikes >= 3) {
        showStealOpportunity();
    } else {
        showMessage(`❌ Strike ${gameData.game.strikes}/3 added!`, 'danger');
    }
    
    // Send update to server
    fetch('/add_strike', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Strike added successfully:', data);
    })
    .catch(error => {
        console.error('Error adding strike:', error);
        showMessage('Error adding strike. Please try again.', 'danger');
    });
}

function switchTeam() {
    console.log('switchTeam called'); // Debug log
    // Award current round points to current team
    awardRoundPoints();
    
    // Switch teams
    gameData.game.current_team = gameData.game.current_team === 1 ? 2 : 1;
    gameData.game.strikes = 0;
    gameData.game.round_points = 0;
    
    updateCurrentTeam();
    updateStrikes(0);
    updateRoundPoints(0);
    
    showMessage(`🔄 Switched to ${getCurrentTeamName()}!`, 'success');
    
    // Send update to server
    fetch('/switch_team', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Team switched successfully:', data);
    })
    .catch(error => {
        console.error('Error switching team:', error);
        showMessage('Error switching team. Please try again.', 'danger');
    });
}

function showStealOpportunity() {
    document.getElementById('steal-section').style.display = 'block';
    document.getElementById('steal-btn').disabled = false;
    isStealMode = false; // Will be set to true when steal button is clicked
    showMessage('🚨 3 strikes! Other team can now attempt to steal!', 'warning');
}

function awardSteal() {
    console.log('awardSteal called'); // Debug log
    if (gameData.game.strikes < 3) {
        showMessage('❌ Cannot steal - less than 3 strikes!', 'danger');
        return;
    }
    
    isStealMode = true;
    showMessage('🎯 Steal mode activated! Click a correct answer to award steal, or add strike if they fail.', 'warning');
}

function awardPointsToStealingTeam() {
    const stealingTeam = gameData.game.current_team === 1 ? 2 : 1;
    const points = gameData.game.round_points;
    
    if (stealingTeam === 1) {
        gameData.game.team1_score += points;
    } else {
        gameData.game.team2_score += points;
    }
    
    // Update display
    updateScores();
    
    // Reset round
    gameData.game.strikes = 0;
    gameData.game.round_points = 0;
    updateStrikes(0);
    updateRoundPoints(0);
    
    // Send to server
    fetch('/award_steal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stealing_team: stealingTeam, points: points })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Steal awarded successfully:', data);
    })
    .catch(error => {
        console.error('Error awarding steal:', error);
        showMessage('Error awarding steal. Please try again.', 'danger');
    });
}

function awardRoundPoints() {
    if (gameData.game.round_points > 0) {
        if (gameData.game.current_team === 1) {
            gameData.game.team1_score += gameData.game.round_points;
        } else {
            gameData.game.team2_score += gameData.game.round_points;
        }
        updateScores();
        
        // Send to server
        fetch('/award_points', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                team: gameData.game.current_team, 
                points: gameData.game.round_points 
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Points awarded successfully:', data);
        })
        .catch(error => {
            console.error('Error awarding points:', error);
            showMessage('Error awarding points. Please try again.', 'danger');
        });
    }
}

function updateScores() {
    const team1ScoreElements = document.querySelectorAll('[style*="font-size: 2rem; font-weight: bold;"]');
    if (team1ScoreElements[0]) team1ScoreElements[0].textContent = gameData.game.team1_score;
    if (team1ScoreElements[1]) team1ScoreElements[1].textContent = gameData.game.team2_score;
}

function updateCurrentTeam() {
    const currentTeamElement = document.getElementById('current-team');
    if (currentTeamElement) {
        currentTeamElement.textContent = getCurrentTeamName();
    }
}

function getCurrentTeamName() {
    return gameData.game.current_team === 1 ? gameData.game.team1_name : gameData.game.team2_name;
}

function updateRoundPoints(points) {
    gameData.game.round_points = points;
    const roundPointsElement = document.querySelector('[style*="font-size: 1.5rem; color: #ffd700;"]');
    if (roundPointsElement) {
        roundPointsElement.textContent = points;
    }
    
    // Send update to server
    fetch('/update_round_points', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ points: points })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Round points updated:', data);
    })
    .catch(error => {
        console.error('Error updating round points:', error);
    });
}

function updateStrikes(strikes) {
    gameData.game.strikes = strikes;
    const strikesDisplay = document.getElementById('strikes-display');
    let strikesHtml = '';
    for (let i = 0; i < strikes; i++) {
        strikesHtml += '❌';
    }
    for (let i = strikes; i < 3; i++) {
        strikesHtml += '⭕';
    }
    strikesDisplay.innerHTML = strikesHtml;
    
    // Hide steal section if strikes reset
    if (strikes < 3) {
        document.getElementById('steal-section').style.display = 'none';
        document.getElementById('steal-btn').disabled = true;
        isStealMode = false;
    }
}

function resetRound() {
    console.log('resetRound called'); // Debug log
    // Hide all revealed answers
    document.querySelectorAll('.answer-slot').forEach(slot => {
        slot.querySelector('.answer-text').style.display = 'none';
        slot.querySelector('.answer-points').style.display = 'none';
        slot.querySelector('.answer-placeholder').style.display = 'block';
        slot.style.background = 'rgba(255,255,255,0.1)';
        slot.style.border = '2px solid rgba(255,255,255,0.3)';
        slot.style.cursor = 'pointer';
    });
    
    // Reset game state
    revealedAnswers.clear();
    gameData.game.strikes = 0;
    gameData.game.round_points = 0;
    isStealMode = false;
    
    updateStrikes(0);
    updateRoundPoints(0);
    document.getElementById('steal-section').style.display = 'none';
    document.getElementById('steal-btn').disabled = true;
    
    showMessage('🔄 Round reset! All answers hidden.', 'success');
    
    // Send to server
    fetch('/reset_round', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Round reset successfully:', data);
    })
    .catch(error => {
        console.error('Error resetting round:', error);
        showMessage('Error resetting round. Please try again.', 'danger');
    });
}

function nextRound() {
    console.log('nextRound called'); // Debug log
    // Award any remaining points
    awardRoundPoints();
    
    fetch('/next_round', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Next round started, reloading page');
            location.reload(); // Reload page for new question
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error starting next round. Please try again.', 'danger');
    });
}

function showMessage(message, type) {
    const messageArea = document.getElementById('message-area');
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.textContent = message;
    
    messageArea.appendChild(messageDiv);
    
    // Auto-remove message after 4 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 4000);
    
    // Scroll to message
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Debug: Log when script loads
console.log('Game script loaded successfully');

// Test function to verify JavaScript is working
window.testFunction = function() {
    console.log('Test function called - JavaScript is working!');
    showMessage('JavaScript is working!', 'success');
};

// Make functions globally available for onclick handlers
window.revealAnswer = revealAnswer;
window.addStrike = addStrike;
window.switchTeam = switchTeam;
window.awardSteal = awardSteal;
window.resetRound = resetRound;
window.nextRound = nextRound;
{% endblock %}